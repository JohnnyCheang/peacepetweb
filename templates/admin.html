{% extends "layout.html" %}

{% block content %}
<style>
/* Admin 样式优化 */
.admin-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
.nav-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
.nav-link { padding: 10px 20px; cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: bold; color: #555; }
.nav-link.active { background: var(--primary); color: white; border-color: var(--primary); }
.tab-pane { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; background: white; border-radius: 0 0 5px 5px; }
.tab-pane.active { display: block; }
.admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.admin-table th, .admin-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
.admin-table th { background-color: #f5f5f5; font-weight: bold; }
.admin-table img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
.input-group-row { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-end; }
.input-group-row > div { flex: 1; }
.form-control { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
fieldset { border: 1px solid #eee; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
legend { width: auto; padding: 0 10px; font-weight: bold; color: var(--primary); }
.section-header { margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; color: var(--primary); font-size: 1.2em; font-weight: bold; }
.font-controls { display: flex; gap: 10px; }
.font-controls select { flex: 2; }
.font-controls input { flex: 1; }
</style>

<div class="admin-container">
    <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">后台管理系统</h2>

    <div class="nav-tabs">
        <div class="nav-link {% if active_tab == 'products' %}active{% endif %}" onclick="showTab('products', this)">产品管理</div>
        <div class="nav-link {% if active_tab == 'categories' %}active{% endif %}" onclick="showTab('categories', this)">分类管理</div>
        <div class="nav-link {% if active_tab == 'settings' %}active{% endif %}" onclick="showTab('settings', this)">页面装修</div>
        <div class="nav-link {% if active_tab == 'feedback' %}active{% endif %}" onclick="showTab('feedback', this)">用户反馈</div>
        <div class="nav-link {% if active_tab == 'orders' %}active{% endif %}" onclick="showTab('orders', this)">订单列表</div>
    </div>

    <div id="products" class="tab-pane {% if active_tab == 'products' %}active{% endif %}">
        <h3>发布新产品</h3>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="admin_action" value="ADD_PRODUCT">
            <div class="input-group-row">
                <div><label>名称 (EN)</label><input type="text" name="title_en" class="form-control" required></div>
                <div><label>名称 (ZH)</label><input type="text" name="title_zh" class="form-control" required></div>
            </div>
            <div class="input-group-row">
                <div><label>价格</label><input type="text" name="price" class="form-control" required></div>
                <div><label>分类</label>
                    <select name="category_id" class="form-control">
                        {% for cat in categories_list %}
                        <option value="{{ cat.id }}">{{ cat.name_zh }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="input-group-row">
                <div><label>月销量</label><input type="number" name="monthly_sales" value="0" class="form-control"></div>
                <div><label>星级</label><input type="text" name="avg_rating" value="5.0" class="form-control"></div>
            </div>
            <div class="input-group-row">
                 <div><label>五点描述 (EN)</label><textarea name="bullet_points_en" rows="3" class="form-control"></textarea></div>
                 <div><label>五点描述 (ZH)</label><textarea name="bullet_points_zh" rows="3" class="form-control"></textarea></div>
            </div>
            <label>主图</label><input type="file" name="main_image" class="form-control" required>
            <div style="margin: 15px 0;">
                 <label><input type="checkbox" name="is_new"> 新品</label>
                 <label><input type="checkbox" name="is_deal"> 优惠</label>
                 <label><input type="checkbox" name="is_featured"> 首页精选</label>
            </div>
            <button class="btn" style="background: var(--primary); color: white;">添加产品</button>
        </form>
        <h3 style="margin-top: 40px;">已发布产品</h3>
        <table class="admin-table">
            <tr><th>图片</th><th>名称</th><th>分类</th><th>价格</th><th>操作</th></tr>
            {% for p in products_list %}
            <tr>
                <td><img src="{{ p.main_image }}"></td>
                <td>{{ p.title_zh }} <br> <small style="color:#777">{{ p.title_en }}</small></td>
                <td>{{ p.category_name_zh }}</td>
                <td>{{ p.price }}</td>
                <td>
                    <a href="{{ url_for('edit_product', product_id=p.id) }}" style="color: blue;">编辑</a>
                    <a href="{{ url_for('delete_product', product_id=p.id) }}" onclick="return confirm('删除?')" style="color: red;">删除</a>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div id="categories" class="tab-pane {% if active_tab == 'categories' %}active{% endif %}">
        <h3>新增分类</h3>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="admin_action" value="ADD_CATEGORY">
            <div class="input-group-row">
                <div><label>名称 (EN)</label><input type="text" name="name_en" class="form-control" required></div>
                <div><label>名称 (ZH)</label><input type="text" name="name_zh" class="form-control" required></div>
            </div>
            <div class="input-group-row">
                <div><label>Slug</label><input type="text" name="slug" class="form-control" required></div>
                <div><label>排序</label><input type="number" name="sort_order" class="form-control" value="0"></div>
            </div>
            <label>分类 Banner 图</label><input type="file" name="category_image" class="form-control">
            <button class="btn" style="background: var(--primary); color: white; margin-top: 10px;">添加分类</button>
        </form>
        <h3 style="margin-top: 40px;">现有分类</h3>
        <table class="admin-table">
            <tr><th>Banner</th><th>名称</th><th>Slug</th><th>操作</th></tr>
            {% for cat in categories_list %}
            <tr>
                <td>{% if cat.image %}<img src="{{ cat.image }}">{% endif %}</td>
                <td>{{ cat.name_zh }} / {{ cat.name_en }}</td>
                <td>{{ cat.slug }}</td>
                <td>
                    <a href="{{ url_for('edit_category', cat_id=cat.id) }}">编辑</a> | 
                    <a href="{{ url_for('delete_category', cat_id=cat.id) }}" style="color: red;">删除</a>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div id="settings" class="tab-pane {% if active_tab == 'settings' %}active{% endif %}">
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="admin_action" value="UPDATE_SETTINGS">

            <div class="section-header">1. Logo & 首页 Banner & 页脚</div>
            <fieldset>
                <div class="input-group-row">
                    <div>
                        <label>站点 Logo</label>
                        <input type="file" name="site_logo_file" class="form-control">
                        {% if settings_dict.site_logo %}
                            <div style="margin: 5px 0;"><img src="{{ settings_dict.site_logo }}" style="height: 40px;"> <label><input type="checkbox" name="delete_logo"> 删除</label></div>
                        {% endif %}
                    </div>
                    <div><label>联系邮箱</label><input type="text" name="contact_email" value="{{ settings_dict.contact_email }}" class="form-control"></div>
                </div>
                <div class="input-group-row">
                    <div><label>页脚文案 (EN)</label><textarea name="footer_text_en" rows="2" class="form-control">{{ settings_dict.footer_text_en }}</textarea></div>
                    <div><label>页脚文案 (ZH)</label><textarea name="footer_text_zh" rows="2" class="form-control">{{ settings_dict.footer_text_zh }}</textarea></div>
                </div>
                <hr>
                <div class="input-group-row">
                    <div>
                        <label>Banner 类型</label>
                        <select name="hero_banner_type" class="form-control">
                            <option value="url" {% if settings_dict.hero_banner_type == 'url' %}selected{% endif %}>URL</option>
                            <option value="upload" {% if settings_dict.hero_banner_type == 'upload' %}selected{% endif %}>上传</option>
                        </select>
                    </div>
                    <div><label>Banner URL</label><input type="text" name="hero_banner_url" value="{{ settings_dict.hero_banner_url }}" class="form-control"></div>
                </div>
                <label>Banner 图片上传</label>
                {% if settings_dict.hero_banner_upload %}
                    <div style="margin: 5px 0;"><img src="{{ settings_dict.hero_banner_upload }}" style="height: 100px;"> <label><input type="checkbox" name="delete_hero_banner_upload"> 删除</label></div>
                {% endif %}
                <input type="file" name="hero_banner_upload_file" class="form-control">

                <div class="input-group-row" style="margin-top: 15px;">
                     <div>
                         <label>标题 (EN)</label><input type="text" name="hero_title_en" value="{{ settings_dict.hero_title_en }}" class="form-control">
                         <div class="font-controls">
                             <select name="hero_title_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.hero_title_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="hero_title_size" value="{{ settings_dict.hero_title_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                     </div>
                     <div>
                         <label>标题 (ZH)</label><input type="text" name="hero_title_zh" value="{{ settings_dict.hero_title_zh }}" class="form-control">
                     </div>
                </div>
                 <div class="input-group-row">
                     <div>
                         <label>Slogan (EN)</label><input type="text" name="hero_slogan_en" value="{{ settings_dict.hero_slogan_en }}" class="form-control">
                         <div class="font-controls">
                             <select name="hero_slogan_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.hero_slogan_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="hero_slogan_size" value="{{ settings_dict.hero_slogan_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                     </div>
                     <div><label>Slogan (ZH)</label><input type="text" name="hero_slogan_zh" value="{{ settings_dict.hero_slogan_zh }}" class="form-control"></div>
                </div>
            </fieldset>

            <div class="section-header">2. 首页 Slogan 板块</div>
            <fieldset>
                <div class="input-group-row">
                    <div>
                        <label>标题 (EN)</label><input type="text" name="home_slogan_title_en" value="{{ settings_dict.home_slogan_title_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="home_slogan_title_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.home_slogan_title_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="home_slogan_title_size" value="{{ settings_dict.home_slogan_title_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>标题 (ZH)</label><input type="text" name="home_slogan_title_zh" value="{{ settings_dict.home_slogan_title_zh }}" class="form-control"></div>
                </div>
                <div class="input-group-row">
                    <div>
                        <label>正文 (EN)</label><textarea name="home_slogan_body_en" rows="2" class="form-control">{{ settings_dict.home_slogan_body_en }}</textarea>
                        <div class="font-controls">
                             <select name="home_slogan_body_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.home_slogan_body_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="home_slogan_body_size" value="{{ settings_dict.home_slogan_body_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>正文 (ZH)</label><textarea name="home_slogan_body_zh" rows="2" class="form-control">{{ settings_dict.home_slogan_body_zh }}</textarea></div>
                </div>
                 <label>侧边图片上传</label>
                {% if settings_dict.home_slogan_img %}
                    <div style="margin: 5px 0;"><img src="{{ settings_dict.home_slogan_img }}" style="height: 80px;"> <label><input type="checkbox" name="delete_home_slogan_image"> 删除</label></div>
                {% endif %}
                <input type="file" name="home_slogan_image_file" class="form-control">
            </fieldset>

            <div class="section-header">3. Deals (优惠) 页面设置</div>
            <fieldset>
                <div class="input-group-row">
                    <div>
                        <label>标题 (EN)</label><input type="text" name="deals_title_en" value="{{ settings_dict.deals_title_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="deals_title_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.deals_title_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="deals_title_size" value="{{ settings_dict.deals_title_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>标题 (ZH)</label><input type="text" name="deals_title_zh" value="{{ settings_dict.deals_title_zh }}" class="form-control"></div>
                </div>
                <div class="input-group-row">
                    <div>
                        <label>文案 (EN)</label><input type="text" name="deals_body_en" value="{{ settings_dict.deals_body_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="deals_body_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.deals_body_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="deals_body_size" value="{{ settings_dict.deals_body_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>文案 (ZH)</label><input type="text" name="deals_body_zh" value="{{ settings_dict.deals_body_zh }}" class="form-control"></div>
                </div>
                <label>Banner 图片上传</label>
                {% if settings_dict.deals_banner_upload %}
                    <div style="margin: 5px 0;"><img src="{{ settings_dict.deals_banner_upload }}" style="height: 60px;"> <label><input type="checkbox" name="delete_deals_banner"> 删除图片</label></div>
                {% endif %}
                <input type="file" name="deals_banner_file" class="form-control">
                <div style="margin-top:10px;"><label>Banner 链接</label><input type="text" name="deals_banner_link" value="{{ settings_dict.deals_banner_link }}" class="form-control"></div>
            </fieldset>

            <div class="section-header">4. New Arrivals (新品) 页面设置</div>
            <fieldset>
                <div class="input-group-row">
                    <div>
                        <label>标题 (EN)</label><input type="text" name="new_title_en" value="{{ settings_dict.new_title_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="new_title_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.new_title_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="new_title_size" value="{{ settings_dict.new_title_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>标题 (ZH)</label><input type="text" name="new_title_zh" value="{{ settings_dict.new_title_zh }}" class="form-control"></div>
                </div>
                <div class="input-group-row">
                    <div>
                        <label>文案 (EN)</label><input type="text" name="new_body_en" value="{{ settings_dict.new_body_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="new_body_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.new_body_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="new_body_size" value="{{ settings_dict.new_body_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>文案 (ZH)</label><input type="text" name="new_body_zh" value="{{ settings_dict.new_body_zh }}" class="form-control"></div>
                </div>
                <label>Banner 图片上传</label>
                {% if settings_dict.new_banner_upload %}
                    <div style="margin: 5px 0;"><img src="{{ settings_dict.new_banner_upload }}" style="height: 60px;"> <label><input type="checkbox" name="delete_new_banner"> 删除图片</label></div>
                {% endif %}
                <input type="file" name="new_banner_file" class="form-control">
                <div style="margin-top:10px;"><label>Banner 链接</label><input type="text" name="new_banner_link" value="{{ settings_dict.new_banner_link }}" class="form-control"></div>
            </fieldset>

             <div class="section-header">5. Product Collection (目录) 页面设置</div>
            <fieldset>
                <div class="input-group-row">
                    <div>
                        <label>标题 (EN)</label><input type="text" name="catalog_title_en" value="{{ settings_dict.catalog_title_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="catalog_title_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.catalog_title_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="catalog_title_size" value="{{ settings_dict.catalog_title_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>标题 (ZH)</label><input type="text" name="catalog_title_zh" value="{{ settings_dict.catalog_title_zh }}" class="form-control"></div>
                </div>
                <div class="input-group-row">
                    <div>
                        <label>文案 (EN)</label><input type="text" name="catalog_body_en" value="{{ settings_dict.catalog_body_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="catalog_body_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.catalog_body_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="catalog_body_size" value="{{ settings_dict.catalog_body_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>文案 (ZH)</label><input type="text" name="catalog_body_zh" value="{{ settings_dict.catalog_body_zh }}" class="form-control"></div>
                </div>
            </fieldset>
            
            <div class="section-header">6. Brand Story (关于我们)</div>
            <fieldset>
                 <div class="input-group-row">
                    <div>
                        <label>标题 (EN)</label><input type="text" name="about_page_title_en" value="{{ settings_dict.about_page_title_en }}" class="form-control">
                        <div class="font-controls">
                             <select name="about_page_title_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.about_page_title_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="about_page_title_size" value="{{ settings_dict.about_page_title_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>标题 (ZH)</label><input type="text" name="about_page_title_zh" value="{{ settings_dict.about_page_title_zh }}" class="form-control"></div>
                </div>
                <div class="input-group-row">
                    <div>
                        <label>正文 (EN)</label><textarea name="about_page_body_en" rows="4" class="form-control">{{ settings_dict.about_page_body_en }}</textarea>
                        <div class="font-controls">
                             <select name="about_page_body_font" class="form-control">{% for f in FONT_OPTIONS %}<option value="{{f}}" {% if settings_dict.about_page_body_font==f %}selected{% endif %}>{{f}}</option>{% endfor %}</select>
                             <input type="text" name="about_page_body_size" value="{{ settings_dict.about_page_body_size }}" class="form-control" placeholder="Size (rem)">
                         </div>
                    </div>
                    <div><label>正文 (ZH)</label><textarea name="about_page_body_zh" rows="4" class="form-control">{{ settings_dict.about_page_body_zh }}</textarea></div>
                </div>
                
                <hr>
                <h5>图片插槽 (3个)</h5>
                {% for item in about_images_data %}
                <div style="background:#f9f9f9; padding:10px; margin-bottom:10px; border-radius:5px;">
                    <strong>Image {{ loop.index }}</strong>
                    <div class="input-group-row">
                        <div style="flex:0 0 100px;">
                             {% if item.src %}
                                <img src="{{ item.src }}" style="width:80px; height:80px; object-fit:cover;">
                                <label style="color:red; font-size:0.8em;"><input type="checkbox" name="delete_{{ item.key }}"> 删除</label>
                             {% else %}
                                <div style="width:80px; height:80px; background:#eee; display:flex; align-items:center; justify-content:center; color:#999;">No Img</div>
                             {% endif %}
                        </div>
                        <div>
                            <label>Upload</label><input type="file" name="{{ item.key }}_file" class="form-control">
                        </div>
                        <div>
                            <label>Desc (EN)</label><input type="text" name="{{ item.key.replace('image', 'caption') }}_en" value="{{ item.caption_en }}" class="form-control">
                            <label>Desc (ZH)</label><input type="text" name="{{ item.key.replace('image', 'caption') }}_zh" value="{{ item.caption_zh }}" class="form-control">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </fieldset>
            
            <button class="btn" style="width: 100%; background: var(--primary); color: white; margin-top: 20px; font-size: 1.2em;">保存所有设置</button>
        </form>
    </div>

    <div id="feedback" class="tab-pane {% if active_tab == 'feedback' %}active{% endif %}">
        <h3>添加用户反馈</h3>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="admin_action" value="ADD_FEEDBACK">
            <select name="product_id" class="form-control">{% for p in products_list %}<option value="{{ p.id }}">{{ p.title_zh }}</option>{% endfor %}</select>
            <textarea name="text_en" class="form-control" placeholder="Feedback (EN)"></textarea>
            <textarea name="text_zh" class="form-control" placeholder="反馈 (ZH)"></textarea>
            <button class="btn" style="background: var(--primary); color: white; margin-top: 10px;">提交</button>
        </form>
    </div>

<script>
function showTab(tabId, btn) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
    history.pushState(null, null, '?tab=' + tabId);
}
</script>
{% endblock %}